#!/usr/bin/env ruby

require 'rubygems'
require 'commander/import'
require 'pathname'
require 'MrMurano'
require 'pp'

program :version, MrMurano::VERSION
program :description, %{nop}

global_option '--verbose', 'Be chatty'
global_option '-n', '--dry', %{Don't run actions that make changes}
global_option '-c', '--config FILE', %{Load additional configuration file}
global_option '--skip-plugins', %{Don't load plugins. Good for when one goes bad.}

# TODO: changing.
#default_command :help

$cfg = MrMurano::Config.new
$cfg.load

# Basic command support is:
# - read/write config file in [Project, User, System] (all are optional)
# - Introspection for tab completion.
# - Look for tools in PATH that are +x and "mr-foo..." 


# Look for plug-ins

pgds = [
  Pathname.new(Dir.home) + '.mrmurano' + 'plugins'
]
# TODO: add plugin dirs from configs
pgds << Pathname.new(ENV['MR_MURANO_PLUGIN_DIR']) if ENV.has_key? 'MR_MURANO_PLUGIN_DIR'
pgds.each do |path|
  next unless path.exist?
  path.each_child do |plugin|
    next if plugin.directory?
    next unless plugin.readable?
    next if plugin.basename.fnmatch('.*') # don't read anything starting with .
    begin
      require plugin.to_s
    rescue Exception => e
      $stderr.puts "Failed to load plugin at #{plugin} because #{e}"
    end
  end
end

#  vim: set ai et sw=2 ts=2 :
