#compdef <%= program :name %>


_<%= program :name %> () {
    local curcontext="$curcontext" state line common_options
    typeset -A opt_args

    common_options=(
    <% for option in @options -%>
      <%- if flatswitches(option).count > 1 -%>
        {<%= flatswitches(option).join(',') %>}<%= takesArg(option) %>"[<%= optionDesc option %>]: :"
      <%- else -%>
        "<%= flatswitches(option).first %><%= takesArg(option) %>[<%= optionDesc option %>]: :"
      <%- end -%>
    <% end %>
    )
    # except this fails when a command only has one arg and then options.
    _arguments -C \
        ':command:->command' \
        '*::options:->options'
    #echo "\n=$curcontext=$state=$words=\n"
    case $state in
        (command)
          local -a list
          list=(
          <%- for name, subs in cmdTree -%>
            <%- cmd = subs["\0cmd"] -%>
            <%- if cmd.nil? -%>
              <%= name %>:'  '
            <%-else-%>
              <%= name %>:'<%= cmd.summary || cmd.description.lines[0] -%>'
            <%-end-%>
          <%end-%>
          )
          _describe -t firstArg 'firstArg' list
          ;;
        (options)
          case $line[1] in
          <%- for name, subs in cmdTree -%>
            (<%= name %>)
              __<%=program :name%>-<%= name %>
            ;;
          <%-end-%>
          esac
          ;;
    esac
}

<%- for  name, subs in cmdTree -%>
  <%- command = subs["\0cmd"]; subs = subs.reject{|k,_| k == "\0cmd"} -%>
__<%=program :name%>-<%= name %> () {
	local curcontext="$curcontext" state line
	typeset -A opt_args

	_arguments -C \
		':command:->command' \
		'*::options:->options'

	case $state in
		(command)
      <%- unless subs.empty? -%>
      local -a subcommands
      subcommands=(
      <%- for sname, _ in subs -%>
        <%=sname%>:''
      <%-end-%>
      )
			_describe -t commands 'subcommsnd' subcommands
      <%-end-%>
      <%- unless command.nil? then -%>
      _arguments \
        <%- for option in command.options -%>
          <%- if flatswitches(option).count > 1 -%>
            {<%= flatswitches(option).join(',') %>}<%= takesArg(option) %>"[<%= optionDesc option %>]: :" \
          <%- else -%>
            "<%= flatswitches(option).first %><%= takesArg(option) %>[<%= optionDesc option %>]: :" \
          <%- end -%>
        <%- end -%>
      <%- end -%>
    ;;
    (options)
      case $line[1] in
      <%- for sname, cmd in subs -%>
        (<%=sname%>)
        ;;
      <%-end-%>
      esac
    ;;
  esac
}
<%- end -%>

#  vim: set ai et sw=2 ts=2 :
